<!doctype html>
<html class="no-js" lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"/>
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <title>Mosaikmissionen in München</title> <!-- version for Munich -->
  <link rel="stylesheet" href="css/foundation.css"/>
  <link rel="stylesheet" href="css/ownStyle.css"/>
  <script src="js/vendor/modernizr.js"></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.23.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.23.0/mapbox-gl.css' rel='stylesheet'/>

  <script src="js/vendor/jquery.js"></script>
  <script src="js/helpFunctions.js"></script>
  <script type="text/javascript" src="missions.js"></script>
  <script type="text/javascript" src="options.js"></script>


</head>
<body>
<!--<div class="row">
    <div class="large-2 small-3 columns">
        <p>This is a test sidebar text</p>
    </div>
    <div class="large-10 small-9 columns">
        <p>This is the main page where the map should be</p>
    </div>
</div>-->

<div class="fixed">
  <nav class="top-bar" data-topbar>
    <ul class="title-area">
      <li class="name">
        <h1><a href="index.html" id="title">Mosaikkarte München</a></h1>
      </li>
      <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
      <li class="toggle-topbar menu-icon active"><a href="#" style="color: #ff8000;"><span>Menü</span></a></li>
    </ul>

    <section class="top-bar-section">
      <ul class="left">
        <!-- include you mosaic here for the menu entry, see template:
         <li><a href="index.html?id=id">mosaicTitle</a></li>
        -->
        <li class="has-dropdown">
          <a href="#" style="color: #ff8000;">Mosaikliste</a>
          <ul class="dropdown">
            <li class="has-dropdown"><a href="#">60er Mosaik</a>
              <ul class="dropdown">
                <li><a href="index.html?id=28">Olympiaturm München</a></li>
                <li><a href="index.html?id=51">Uptown München</a></li>
              </ul>
            </li>
            <li class="has-dropdown"><a href="#">54er Mosaik</a>
              <ul class="dropdown">
                <li><a href="index.html?id=56">Sound & Vision</a></li>
              </ul>
            </li>
            <li class="has-dropdown"><a href="#">48er Mosaik</a>
              <ul class="dropdown">
                <li><a href="index.html?id=55">Blauer Reiter</a></li>
              </ul>
            </li>
            <li class="has-dropdown"><a href="#">36er Mosaik</a>
              <ul class="dropdown">
                <li><a href="index.html?id=38">Celtic Knot</a></li>
              </ul>
            </li>
            <li class="has-dropdown"><a href="#">24er Mosaike</a>
              <ul class="dropdown">
                <li><a href="index.html?id=42">Antiquarium München</a></li>
                <li><a href="index.html?id=52">Blue Sun Garching</a></li>
                <li><a href="index.html?id=16">Districts of Munich</a></li>
                <li><a href="index.html?id=23">Das große Biergartenmosaik</a></li>
                <li><a href="index.html?id=46">Endless I</a></li>
                <li><a href="index.html?id=31">Karlsplatz, Stachus</a></li>
                <li><a href="index.html?id=4">Marienplatz</a></li>
                <li><a href="index.html?id=2">Münchner Kindl</a></li>
                <li><a href="index.html?id=12">Munich City</a></li>
                <li><a href="index.html?id=53">Munich City Walls</a></li>
                <li><a href="index.html?id=10">Munich Portal Hunter Stroll</a></li>
                <li><a href="index.html?id=43">Schleissheim Postcard</a></li>
                <li><a href="index.html?id=49">1972 Summer Olympics</a></li>
                <li><a href="index.html?id=30">Stadtwappen Dachau</a></li>
                <li><a href="index.html?id=57">Tatort Hadern</a></li>
                <li><a href="index.html?id=32">X-MAS Mosaik</a></li>
              </ul>
            </li>
            <li class="has-dropdown"><a href="#">18er Mosaike</a>
              <ul class="dropdown">
                <li><a href="index.html?id=47">Endless II</a></li>
                <li><a href="index.html?id=34">FFB Enl-Mosaik</a></li>
                <li><a href="index.html?id=21">Germeringer Kermit</a></li>
                <li><a href="index.html?id=9">Ismaning Mosaik</a></li>
                <li><a href="index.html?id=50">Marienplatz Tal (1890)</a></li>
                <li><a href="index.html?id=33">The Shapers Eye</a></li>
              </ul>
            </li>
            <li class="has-dropdown"><a href="#">12er Mosaike</a>
              <ul class="dropdown">
                <li><a href="index.html?id=48">Endless III</a></li>
                <li><a href="index.html?id=19">Spaziergang durch Erding</a></li>
                <li><a href="index.html?id=11">Spiderweb</a></li>
                <li><a href="index.html?id=54">Starnberg</a></li>
                <li><a href="index.html?id=13">Sunset at the Lake</a></li>
              </ul>
            </li>
            <li class="has-dropdown"><a href="#">6er Mosaike</a>
              <ul class="dropdown">
                <li><a href="index.html?id=36">AURUM Dachau</a></li>
                <li><a href="index.html?id=37">ARGENTUM Dachau</a></li>
                <li><a href="index.html?id=15">Äußerer Radring</a></li>
                <li><a href="index.html?id=41">EXPUGNA SENTILINGA</a></li>
                <li><a href="index.html?id=22">Germering</a></li>
                <li><a href="index.html?id=14">Innerer Radring</a></li>
                <li><a href="index.html?id=45">Oberhachinger Runde</a></li>
                <li><a href="index.html?id=27">Pullach im Isartal</a></li>
              </ul>
            </li>
            <li class="has-dropdown"><a href="#">5er Mosaik</a>
              <ul class="dropdown">
                <li><a href="index.html?id=35">Türkenfeld</a></li>
              </ul>
            </li>
            <li class="has-dropdown"><a href="#">4er Mosaike</a>
              <ul class="dropdown">
                <li><a href="index.html?id=17">Englischer Garten</a></li>
                <li><a href="index.html?id=8">I love München</a></li>
                <li><a href="index.html?id=29">Münchens Biergärten</a></li>
                <li><a href="index.html?id=18">Trudering</a></li>
              </ul>
            </li>
            <li class="has-dropdown"><a href="#">3er Mosaike</a>
              <ul class="dropdown">
                <li><a href="index.html?id=5">Hachinger Bach</a></li>
                <li><a href="index.html?id=24">Schloss Nymphenburg</a></li>
                <li><a href="index.html?id=44">Schlösser in Oberschleißheim</a></li>
              </ul>
            </li>
            <!-- previously used for the special starwars missions
            <li class="has-dropdown"><a href="#">Spezialmissionen</a>
                <ul class="dropdown">
                    <li></li>
                </ul>
            </li> -->
          </ul>
        </li>
        <li><a href="info.html">Legende</a></li> <!-- legend -->
        <li><a href="overview.html">Übersicht</a></li> <!-- overview withour map -->
        <li><a href="contact.html">Kontakt</a></li> <!-- contact information -->
      </ul>
    </section>
  </nav>
</div>
<div id="map"></div>
<script>
  $(document).ready(function () {
    var totalPortals = 0;
    var uniquePortals = 0;
    var authorName = null;
    var actionCount = 0;
    var countPortalsInMission = 0;
    var countFieldtripsInMission = 0;
    var countActionHack = 0;
    var countActionCapture = 0;
    var countActionLink = 0;
    var countActionField = 0;
    var countActionMod = 0;
    var countActionPhoto = 0;
    var countActionViewWaypoint = 0;
    var countActionPassphrase = 0;
    var missionLength = 0;
    var asOf;
    var medianCompletionTime = 0;
    var iterateMissionsString = "";
    var startTitle = [];
    var startDescription = [];
    var startImage = [];
    var startInfo = [];
    var startId = [];

    // initialize background map
    mapboxgl.accessToken = mapbox_accesstoken;

    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v9',
      center: [11.57, 48.14],
      zoom: 14,
      minZoom: 10,
      maxZoom: 17,
      hash: true,
      maxBounds: bounds
    });

    map.addControl(new mapboxgl.Navigation({position: 'top-right'}));
    map.addControl(new mapboxgl.Geolocate({position: 'top-right'}));

    map.on('load', function () {
      map.addSource("startPoints", {
        type: "geojson",
        data: "./geojson/startpoints.geojson",
        cluster: true,
        clusterMaxZoom: 17, // Max zoom to cluster points on
        clusterRadius: 20 // Radius of each cluster when clustering points (defaults to 50)
      });

      map.addLayer({
        "id": "unclustered-points",
        "type": "circle",
        "source": "startPoints",
        "paint": {
          "circle-color": "#ff8000",
          "circle-radius": 11,
          "circle-blur": 0.3
        },
      });

      // Display the earthquake data in three layers, each filtered to a range of
      // count values. Each range gets a different fill color.
      var layers = [
        [3, '#8db600'],
        [2, '#ffe135'],
        [0, '#ff8000']
      ];

      layers.forEach(function (layer, i) {
        map.addLayer({
          "id": "cluster-" + i,
          "type": "circle",
          "source": "startPoints",
          "paint": {
            "circle-color": layer[1],
            "circle-radius": 18,
            "circle-blur": 0.2
          },
          "filter": i === 0 ?
              [">=", "point_count", layer[0]] :
              ["all",
                [">=", "point_count", layer[0]],
                ["<", "point_count", layers[i - 1][0]]]
        });
      });

      // Add a layer for the clusters' count labels
      map.addLayer({
        "id": "cluster-count",
        "type": "symbol",
        "source": "startPoints",
        "layout": {
          "text-field": "{point_count}",
          "text-font": [
            "DIN Offc Pro Medium",
            "Arial Unicode MS Bold"
          ],
          "text-size": 12
        }
      });

    });
    var popup = new mapboxgl.Popup({
      closeButton: false,
      closeOnClick: false
    });
    map.on('mousemove', function (e) {
      var features_startPoints = map.queryRenderedFeatures(e.point, {layers: ['unclustered-points', 'cluster-1', 'cluster-2']});
      console.log(features_startPoints);
      // Change the cursor style as a UI indicator.
      map.getCanvas().style.cursor = (features_startPoints.length) ? 'pointer' : '';

      if (!features_startPoints.length) {
        popup.remove();
        return;
      }

      var feature_cluster = features_startPoints[0];

      /*map.flyTo({
        center: feature_cluster.geometry.coordinates,
        zoom: 17,
        speed: 0.4,
        curve: 1
      });*/

      if (feature_cluster.properties.point_count) {
        $.when(iterateMissionsPopup(feature_cluster))
            .done(function () {
              // avoid creation of a new popup when the mouse position is slightly changed,
              // and the asnc calls create double entries in the mission arrays.
              // it is also useful to avoid bad popup behaviour on mobile devices
              if(startTitle.length === feature_cluster.properties.point_count) {
                console.log(startTitle);
                var missionString = "";
                for(var i = 0; i< startTitle.length; i++){
                  missionString += '</br><a href="index.html?id='+startId[i]+'">'+startTitle[i]+'</a>';
                }
              }
              else if(startTitle.length === 0){
                missionString = "</br>Zoome für mehr Details";
              }
              popup.setLngLat(feature_cluster.geometry.coordinates)
                  .setHTML("Hier starten " + feature_cluster.properties.point_count + " Missionen " + missionString)
                  .addTo(map);
              startTitle = [];
              startDescription = [];
              startImage = [];
              startInfo = [];
              startId = [];
            })
            .always(function () {

            });
      }
      else {
        popup.setLngLat(feature_cluster.geometry.coordinates)
            .setHTML(feature_cluster.properties.description)
            .addTo(map);
      }
    });

    function iterateMissionsPopup(feature) {
      //var missions = "";
      $.getJSON('./geojson/startpoints.geojson',
          function (points) {
            var result = points.features;
            for (var i = 0; i < result.length; i++) {
              if (feature.geometry.coordinates[0].toFixed(4) === result[i].geometry.coordinates[0].toFixed(4) &&
                  feature.geometry.coordinates[0].toFixed(4) === result[i].geometry.coordinates[0].toFixed(4)) {
                startTitle.push(result[i].properties.title);
                startDescription.push(result[i].properties.description);
                startImage.push(result[i].properties.imagePath);
                startInfo.push(result[i].properties.info);
                startId.push(result[i].properties.id);
              }
              console.log(result[i].properties.title);
              console.log("mouseoverFeature --> " + feature.geometry.coordinates[0].toFixed(4));
              console.log("origMissionCoord --> " + result[i].geometry.coordinates[0].toFixed(4));
            }
            //console.log("missionen--> " + missions);

          });
    }

    /*map.on('mousemove', function (e) {
     var features = map.queryRenderedFeatures(e.point, {layers: ['cluster-1']});
     console.log(features);
     // Change the cursor style as a UI indicator.
     //map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';

     if (!features.length) {
     popup.remove();
     return;
     }

     var feature = features[0];

     // Populate the popup and set its coordinates
     // based on the feature found.
     if (feature.properties.point_count) {
     var missions = "";
     $.getJSON('./geojson/startpoints.geojson',
     function (data) {
     var result = data.features;
     for (var i = 0; i < result.length; i++) {
     if( feature.geometry.coordinates[0].toFixed(4) === result[i].geometry.coordinates[0].toFixed(4) &&
     feature.geometry.coordinates[0].toFixed(4) === result[i].geometry.coordinates[0].toFixed(4))
     missions += result[i].properties.title +"  ";

     console.log(result[i].properties.title);
     console.log("mouseoverFeature --> "+feature.geometry.coordinates[0].toFixed(4));
     console.log("origMissionCoord --> "+result[i].geometry.coordinates[0].toFixed(4));
     }
     console.log("missionen--> " + missions);
     popup.setLngLat(feature.geometry.coordinates)
     .setHTML("Hier starten die Missionen: " + missions)
     .addTo(map);
     });

     }
     });*/
  });


  /*

   // When a click event occurs near a marker icon, open a popup at the location of
   // the feature, with description HTML from its properties.
   map.on('click', function (e) {
   var features = map.queryRenderedFeatures(e.point, { layers: ['start'] });

   if (!features.length) {
   return;
   }

   var feature = features[0];
   map.flyTo({
   center: features[0].geometry.coordinates,
   speed: 1
   });
   // Populate the popup and set its coordinates
   // based on the feature found.
   var popup = new mapboxgl.Popup({
   "closeButton": false,
   "closeOnClick": true,
   "anchor": "bottom"
   })
   .setLngLat(feature.geometry.coordinates)
   .setHTML(
   '<h6>' + feature.properties.title + '</h6>'
   // popup content, text in german, meaning/content is described in the comments after the p-tag
   + '<span>Ersteller: </span>' + authorName +'<br/>' // author
   + '<span>Zeit: </span>ca. ' + calcTime(medianCompletionTime)+'<br/>' // median completion time
   + '<span>Länge: </span>ca. ' + '5h' +'<br/>'// length of the mission, linear distance including the distance between the individual missions
   + '<span>Aktionen: </span>' + 'all' +'<br/>' // type and count of actions that need to be fulfilled during the mosaic
   + '<span>Gesamtanzahl Portale: </span>' + 'total' +'<br/>' // number of total portals in the mosaic
   + '<span>Anzahl Unique Portale: </span>' + 'unique' +'<br/>' // number of unique portals a player visits during the mosaic, contains no portals between the individual missions
   + '<span>Mehr: </span>' + feature.properties.description +'<br/>' // shows the description specified during the export process from the intel
   + '<span>Download: </span><a href="' + feature.properties.imagePath.replace('pics', 'kml').replace('.jpg', '.kml') + '">Download als kml</a>'
   )
   .addTo(map);
   });

   map.on("mousemove", function(e) {
   var features = map.queryRenderedFeatures(e.point, { layers: ["route"] });
   if (features.length) {
   map.setFilter("route-hover", ["==", "title", features[0].properties.title]);
   } else {
   map.setFilter("route-hover", ["==", "title", ""]);
   }
   });*/


  // create ClusterGroup for start points on the main map
  /*var markers = new L.MarkerClusterGroup({
   spiderfyOnMaxZoom: true,
   showCoverageOnHover: false,
   zoomToBoundsOnClick: true,
   maxClusterRadius: 20,
   spiderfyDistanceMultiplier: 2
   });

   /!**
   * shows all start portals of every single mosaic, when no specific one is choosen
   *!/
   function showStartPortals() {
   // include your mosaic here, see template:
   /!*
   markers.addLayer( L.geoJson(mosaicName_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   *!/

   markers.addLayer(L.geoJson(kindl_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(marienplatz_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(bach_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(love_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(ismaning_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(stroll_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(spiderweb_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(city_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(sunset_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(innen_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(aussen_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(districts_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(garten_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(trudering_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(erding_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(kermit_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(germering_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(biergarten_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(nymphenburg_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(pullach_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(olyturm_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(bier_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(dachau_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(stachus_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(xmas_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(shapers_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(ffbenl_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(turk_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(aurum_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(argentum_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(celtic_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));

   markers.addLayer(L.geoJson(sendling_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(antiquar_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(postcard_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(oberhaching_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(schleiss_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(endlessI_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(endlessII_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(endlessIII_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(olympics_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(tal_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(uptown_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(blueSun_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(walls_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(starnberg_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(reiter_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(sound_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   markers.addLayer(L.geoJson(tatort_startMissions.features[0], {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachPointOverview
   }));
   map.addLayer(markers);
   }
   switch (getQueryVariable("id")) {
   // include your mosaic here, see template:
   /!*
   case "mosaicID":
   prepareMission(mosaicName_mission, mosaicName_startMissions);
   break;
   *!/
   case "mosaicID":
   prepareMission(mosaicName_mission, mosaicName_startMissions);
   break;
   case "2":
   prepareMission(kindl_mission, kindl_startMissions);
   break;
   // case 3 was: Weihnachtliches München
   case "4":
   prepareMission(marienplatz_mission, marienplatz_startMissions);
   break;
   case "5":
   prepareMission(bach_mission, bach_startMissions);
   break;
   // case 6 was: Hacken in Giesing
   // case 7 was: Endless 54 total
   case "8":
   prepareMission(love_mission, love_startMissions);
   break;
   case "9":
   prepareMission(ismaning_mission, ismaning_startMissions);
   break;
   case "10":
   prepareMission(stroll_mission, stroll_startMissions);
   break;
   case "11":
   prepareMission(spiderweb_mission, spiderweb_startMissions);
   break;
   case "12":
   prepareMission(city_mission, city_startMissions);
   break;
   case "13":
   prepareMission(sunset_mission, sunset_startMissions);
   break;
   case "14":
   prepareMission(innen_mission, innen_startMissions);
   break;
   case "15":
   prepareMission(aussen_mission, aussen_startMissions);
   break;
   case "16":
   prepareMission(districts_mission, districts_startMissions);
   break;
   case "17":
   prepareMission(garten_mission, garten_startMissions);
   break;
   case "18":
   prepareMission(trudering_mission, trudering_startMissions);
   break;
   case "19":
   prepareMission(erding_mission, erding_startMissions);
   break;
   case "21":
   prepareMission(kermit_mission, kermit_startMissions);
   break;
   case "22":
   prepareMission(germering_mission, germering_startMissions);
   break;
   case "23":
   prepareMission(biergarten_mission, biergarten_startMissions);
   break;
   case "24":
   prepareMission(nymphenburg_mission, nymphenburg_startMissions);
   break;
   // case 25 was: Westkreuz
   // case 26 was: Pasing Wappen
   case "27":
   prepareMission(pullach_mission, pullach_startMissions);
   break;
   case "28":
   prepareMission(olyturm_mission, olyturm_startMissions);
   break;
   case "29":
   prepareMission(bier_mission, bier_startMissions);
   break;
   case "30":
   prepareMission(dachau_mission, dachau_startMissions);
   break;
   case "31":
   prepareMission(stachus_mission, stachus_startMissions);
   break;
   case "32":
   prepareMission(xmas_mission, xmas_startMissions);
   break;
   case "33":
   prepareMission(shapers_mission, shapers_startMissions);
   break;
   case "34":
   prepareMission(ffbenl_mission, ffbenl_startMissions);
   break;
   case "35":
   prepareMission(turk_mission, turk_startMissions);
   break;
   case "36":
   prepareMission(aurum_mission, aurum_startMissions);
   break;
   case "37":
   prepareMission(argentum_mission, argentum_startMissions);
   break;
   case "38":
   prepareMission(celtic_mission, celtic_startMissions);
   break;
   // case 39 was: dachau goes war craft
   case "40":
   prepareMission(star_mission, star_startMissions);
   break;
   case "41":
   prepareMission(sendling_mission, sendling_startMissions);
   break;
   case "42":
   prepareMission(antiquar_mission, antiquar_startMissions);
   break;
   case "43":
   prepareMission(postcard_mission, postcard_startMissions);
   break;
   case "44":
   prepareMission(schleiss_mission, schleiss_startMissions);
   break;
   case "45":
   prepareMission(oberhaching_mission, oberhaching_startMissions);
   break;
   case "46":
   prepareMission(endlessI_mission, endlessI_startMissions);
   break;
   case "47":
   prepareMission(endlessII_mission, endlessII_startMissions);
   break;
   case "48":
   prepareMission(endlessIII_mission, endlessIII_startMissions);
   break;
   case "49":
   prepareMission(olympics_mission, olympics_startMissions);
   break;
   case "50":
   prepareMission(tal_mission, tal_startMissions);
   break;
   case "51":
   prepareMission(uptown_mission, uptown_startMissions);
   break;
   case "52":
   prepareMission(blueSun_mission, blueSun_startMissions);
   break;
   case "53":
   prepareMission(walls_mission, walls_startMissions);
   break;
   case "54":
   prepareMission(starnberg_mission, starnberg_startMissions);
   break;
   case "55":
   prepareMission(reiter_mission, reiter_startMissions);
   break;
   case "56":
   prepareMission(sound_mission, sound_startMissions);
   break;
   case "57":
   prepareMission(tatort_mission, tatort_startMissions);
   break;
   default:
   showStartPortals();
   break;
   }
   /!**
   * prepares mission details, when the mission should be displayed
   *!/
   function prepareMission(feature, startMissions) {
   document.getElementById("title").innerHTML = "◄ " + startMissions.features[0].properties.title;
   var arrayPortals = [];
   var arrayPortalTypeNum = [];
   var arrayPortalObjectiveNum = [];

   for (var i = feature.features.length - 1; i >= 0; i--) {
   // collect all waypoints of the mosaic
   for (var j = feature.features[i].geometry.coordinates.length - 1; j >= 0; j--) {
   arrayPortals.push(feature.features[i].geometry.coordinates[j]);
   }
   // collect all type of every waypoint of the mosaic
   arrayPortalTypeNum.push(feature.features[i].properties.portalTypeNum);
   // collect all objectives (actions) of every waypoint of the mosaic
   arrayPortalObjectiveNum.push(feature.features[i].properties.portalObjectiveNum);
   // count total completion time of the mosaic
   medianCompletionTime += feature.features[i].properties.medianCompletionTimeMs;
   }

   // calc mission length incl. gaps between the missions itself
   var tempLength = 0;
   for (var i = 0; i < arrayPortals.length - 1; i++) {
   tempLength += calcDistance(arrayPortals[i], arrayPortals[i + 1]);
   }
   missionLength = tempLength;

   countPortalsInMission = $.grep(arrayToOneDimension(arrayPortalTypeNum), function (elem) {
   return elem === 1; // value for Portal
   }).length;
   countFieldtripsInMission = $.grep(arrayToOneDimension(arrayPortalTypeNum), function (elem) {
   return elem === 2; // value for Fieldtrip Waypoint
   }).length;
   countActionHack = $.grep(arrayToOneDimension(arrayPortalObjectiveNum), function (elem) {
   return elem === 1; // value for Action Hack
   }).length;
   countActionCapture = $.grep(arrayToOneDimension(arrayPortalObjectiveNum), function (elem) {
   return elem === 2; // value for Action Capture or Upgrade
   }).length;
   countActionLink = $.grep(arrayToOneDimension(arrayPortalObjectiveNum), function (elem) {
   return elem === 3; // value for Action Create Link from Portal
   }).length;
   countActionField = $.grep(arrayToOneDimension(arrayPortalObjectiveNum), function (elem) {
   return elem === 4; // value for Action Create Field from Portal
   }).length;
   countActionMod = $.grep(arrayToOneDimension(arrayPortalObjectiveNum), function (elem) {
   return elem === 5; // value for Action Install Mod on Portal
   }).length;
   countActionPhoto = $.grep(arrayToOneDimension(arrayPortalObjectiveNum), function (elem) {
   return elem === 6; // value for Action Take a Photo
   }).length;
   countActionViewWaypoint = $.grep(arrayToOneDimension(arrayPortalObjectiveNum), function (elem) {
   return elem === 7; // value for Action View this Fieldtrip Waypoint
   }).length;
   countActionPassphrase = $.grep(arrayToOneDimension(arrayPortalObjectiveNum), function (elem) {
   return elem === 8; // value for Action Enter the Passphrase
   }).length;

   asOf = new Date(feature.features[0].properties.time);

   authorName = feature.features[0].properties.author;
   totalPortals = arrayPortals.length;
   uniquePortals = unique(arrayPortals).length;

   var missionLayer = L.geoJson(feature, {
   style: missionStyles,
   onEachFeature: onEachFeature
   });
   var startSingleMissions = L.geoJson(startMissions, {
   pointToLayer: startMissionStyle,
   onEachFeature: onEachStartPoint
   });

   map.addLayer(missionLayer);
   map.addLayer(startSingleMissions);
   //set mapView to the start of the mosaic
   map.setView([startMissions.features[0].geometry.coordinates[1], startMissions.features[0].geometry.coordinates[0]], 16);
   }

   /!**
   * set popup content for every mission
   * @param feature
   *!/
   function onEachFeature(feature, layer) {
   // here you can configure the label content for every mission
   var popupContent = "";
   if (feature.properties && feature.properties.title && feature.properties.typeNumMission) {
   popupContent += feature.properties.title /!*+'</br>Dauer: ca. '+ calcTime(feature.properties.medianCompletionTimeMs)*!/;
   }

   layer.bindLabel(popupContent);

   layer.on("mouseover", function () {
   layer.setStyle({
   "weight": 8
   })
   });
   layer.on("mouseout", function () {
   layer.setStyle({
   "weight": 4
   })
   });
   layer.on("click", function () {
   layer.setStyle({
   "weight": 8
   })
   });
   }

   /!**
   * set visualization of the mission, depending on the type ('sequential' or 'non sequential')
   * @param feature
   * @returns style
   *!/
   function missionStyles(feature) {
   if (feature.properties && feature.properties.typeNumMission) {
   switch (feature.properties.typeNumMission) {
   case 2: //non sequential
   return {
   "color": '#ff8000',
   "dashArray": "5,8",
   "smoothFactor": 1,
   "lineJoin": "round",
   "opacity": 1,
   "weight": 4
   };
   case 1: //sequential
   return {
   "color": '#ff8000',
   "smoothFactor": 1,
   "lineJoin": "round",
   "opacity": 1,
   "weight": 4
   };
   }
   }
   }

   function createHTMLImageString(feature){
   var stringMissionPictures ="";
   var missionName = feature.properties.imagePath.substring(5, feature.properties.imagePath.lastIndexOf("."))+'_';
   // creates the html string for the mission images,
   // window[missionName+"mission"] is used to access the according variable and to get the number of missions in the mosaic
   for(var i = window[missionName+"mission"].features.length-1; i >=0; i--){
   // change the .jpg when you use another file format for the pictures
   stringMissionPictures += '<nobr><img src="pics/'+missionName+(i+1)+'.jpg"  style="padding:2px;width: 40px;height: 40px;">';
   if(i%6==0)
   stringMissionPictures += "</br>";
   }
   return  stringMissionPictures;
   }

   /!**
   * defines what is visible when clicking on the mission start point at the overview map
   * @param feature
   * @param layer
   *!/
   function onEachPointOverview(feature, layer) {
   if (feature.properties && feature.properties.title) {
   layer.bindPopup(
   '<h4>' + feature.properties.title + '</h4>'
   + createHTMLImageString(feature)
   + '<p><a href="index.html?id=' + feature.properties.id + '">Details/Route in der Karte anzeigen</a></p>');
   }
   }
   /!**
   * create popup content for the first mission, when the user clicks on the start point
   * @param feature
   * @param layer
   *!/
   function onEachStartPoint(feature, layer) {
   if (feature.properties && feature.properties.missionNumber) {
   // create clickable intel-link for every mission start as label
   layer.bindLabel('<a target="_blank" id="linkPortal" title="Startportal in Intel aufrufen" href="https://www.ingress.com/intel?' + feature.geometry.coordinates[1] + ',' + feature.geometry.coordinates[0] + '&z=17&pll=' + feature.geometry.coordinates[1] + ',' + feature.geometry.coordinates[0] + '">' + feature.properties.missionNumber.toString() + '</a>', {
   noHide: true
   });
   // add a popup with information on the start point of the first mission
   switch (feature.properties.missionNumber) {
   // include possible special cases for the first mission here, see README.md for details
   case "1-12": // special pattern solely for the spiderweb-mosaic
   case "1, 7": // special pattern solely for the sunset-mosaic
   case "1, 3": // special pattern solely for the germering-mosaic
   case 1:
   if (feature.properties && feature.properties.title) {
   // concat action string
   var actionsString = [];
   if (countActionHack > 0) {
   actionsString.push(countActionHack + ' x Hack'); // hack
   }
   if (countActionCapture > 0) {
   actionsString.push(countActionCapture + ' x Capture oder Upgrade'); // capture or upgrade
   }
   if (countActionLink > 0) {
   actionsString.push(countActionLink + ' x Link erstellen'); // create link from portal
   }
   if (countActionField > 0) {
   actionsString.push(countActionField + ' x Feld erstellen'); // create field from portal
   }
   if (countActionMod > 0) {
   actionsString.push(countActionMod + ' x Mod deployen'); // deploy mod
   }
   if (countActionPhoto > 0) {
   actionsString.push(countActionPhoto + ' x Photo machen'); // take photo, action not available in mission editor
   }
   if (countActionViewWaypoint > 0) {
   actionsString.push(countActionViewWaypoint + ' x Fieldtrip Waypoint'); // view fieldtrip waypoint
   }
   if (countActionPassphrase > 0) {
   actionsString.push(countActionPassphrase + ' x Passphrase eingeben'); // enter passphrase
   }
   // create output mission length
   var outputMissionLength = "";
   if (missionLength < 1) {
   //when length < 1km display the value in meters
   outputMissionLength += (missionLength * 1000).toFixed(0) + ' m'
   } else {
   // when length > 1km display the value in kilometers
   outputMissionLength += missionLength.toFixed(2) + ' km'
   }


   var popupContent =
   '<h4>' + feature.properties.title + '</h4>'
   // popup content, text in german, meaning/content is described in the comments after the p-tag
   + '<p><span>Ersteller: </span>' + authorName + '</p>' // author
   + '<p><span>Zeit: </span>ca. ' + calcTime(medianCompletionTime) + '</p>' // median completion time
   + '<p><span>Länge: </span>ca. ' + outputMissionLength + '</p>' // length of the mission, linear distance including the distance between the individual missions
   + '<p><span>Aktionen: </span>' + actionsString.join(", ") + '</p>' // type and count of actions that need to be fulfilled during the mosaic
   + '<p><span>Gesamtanzahl Portale: </span>' + totalPortals + '</p>' // number of total portals in the mosaic
   + '<p><span>Anzahl Unique Portale: </span>' + uniquePortals + '</p>' // number of unique portals a player visits during the mosaic, contains no portals between the individual missions
   + '<p><span>Mehr: </span>' + feature.properties.description + '</p>' // shows the description specified during the export process from the intel
   + '<p><span>Download: </span><a href="' + feature.properties.imagePath.replace('pics', 'kml').replace('.jpg', '.kml') + '">Download als kml</a>' + '</p>'; // create downloadlink for the kml file, which was specified during export from the intel
   // in case a G+ post with more information from the mosaic was specified during the export process, it is included here
   if (feature.properties.info != "---") {
   popupContent += '<p><span>G+: </span><a href="' + feature.properties.info + '">mehr Infos auf G+</a></p>' // more infos on G+
   } else {
   popupContent += '<p><span>G+: </span>Leider kein G+ Post verfügbar</p>' // unfortunately there is no G+ post available
   }
   popupContent += createHTMLImageString(feature)
   + '<p><span>Stand vom: </span>' + asOf.getDate() + '.' + (asOf.getMonth()+ 1)  + '.' + asOf.getFullYear() + '</p>'; // mission data as of the export date from the mosaic

   layer.bindPopup(popupContent);
   }
   break;
   }
   }
   }
   /!**
   * returns style of the mission marker - a bigger coloured point for the first mission and small rings for the other missions
   * @param feature
   * @param latlng
   * @returns style
   *!/
   function startMissionStyle(feature, latlng) {
   switch (feature.properties.missionNumber) {
   case "1-12": // special pattern solely for the spiderweb-mosaic
   case "1, 7": // special pattern solely for the sunset-mosaic
   case "1, 3": // special pattern solely for the germering-mosaic
   case 1:
   return L.circleMarker(latlng, {
   radius: 8,
   fillColor: '#ff8000',
   color: '#fff',
   weight: 2,
   opacity: 1,
   fillOpacity: 1
   });
   break;
   default:
   return L.circleMarker(latlng, {
   radius: 5,
   color: '#bbb',
   fillOpacity: 0,
   opacity: 1
   });
   break;
   }
   }
   /!**
   * returns the value of id, that is provided, when a mission is selected in the menu or from the overview page
   * @param variable
   * @returns value of id
   *!/
   function getQueryVariable(variable) {
   var query = window.location.search.substring(1);
   var vars = query.split("&");
   for (var i = 0; i < vars.length; i++) {
   var pair = vars[i].split("=");
   if (pair[0] == variable) {
   return pair[1];
   }w
   }
   return (false);
   }*/
</script>
<script src="js/foundation.min.js"></script>
<script>
  $(document).foundation({
    topbar: {
      custom_back_text: true,
      back_text: 'Zurück'
    }
  });
</script>
</body>
</html>
 